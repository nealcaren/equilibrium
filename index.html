<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equilibrium: A Durkheim Solidarity Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
            min-height: 100vh;
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
        }
        .card {
            transition: transform 0.7s ease-in-out, opacity 0.7s ease-in-out;
            transform-style: preserve-3d;
            backface-visibility: hidden;
        }
        .card-container.player-turn .choice-box:hover {
            transform: translateY(-4px);
            border-color: #22d3ee; /* cyan-400 */
        }
        .card-swipe-left {
            transform: translateX(-150%) rotate(-15deg);
            opacity: 0;
        }
        .card-swipe-right {
            transform: translateX(150%) rotate(15deg);
            opacity: 0;
        }
        .modal, .overlay {
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
        }
        .status-icon {
            transition: transform 0.3s ease-in-out;
        }
        .status-icon.danger {
            transform: scale(1.2);
            color: #ef4444; /* red-500 */
        }
        .choice-box {
             transition: transform 0.2s ease-in-out, border-color 0.2s ease-in-out;
             cursor: pointer;
        }
        .anomie-warning {
            animation: anomie-pulse 1s ease-in-out infinite;
        }
        @keyframes anomie-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .era-notification {
            animation: era-slide-in 0.5s ease-out;
        }
        @keyframes era-slide-in {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        /* Tutorial styles */
        .tutorial-highlight {
            position: relative;
            z-index: 100;
            box-shadow: 0 0 0 4px rgba(34, 211, 238, 0.6), 0 0 20px rgba(34, 211, 238, 0.4);
            border-radius: 8px;
        }
        .tutorial-overlay {
            backdrop-filter: blur(2px);
        }
        .tutorial-content {
            line-height: 1.5;
        }
        @media (max-width: 640px) {
            .tutorial-content {
                line-height: 1.4;
            }
        }
        .tutorial-content strong {
            color: #22d3ee;
        }
        .tutorial-content em {
            color: #a78bfa;
        }
        .tutorial-progress {
            display: flex;
            gap: 6px;
            justify-content: center;
        }
        .tutorial-progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4b5563;
            transition: background 0.3s;
        }
        .tutorial-progress-dot.active {
            background: #22d3ee;
        }
        .tutorial-progress-dot.completed {
            background: #10b981;
        }
        /* Contextual tips - non-blocking floating hints */
        .contextual-tip {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            max-width: 90%;
            width: 320px;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            z-index: 100;
            animation: tip-appear 0.3s ease-out;
            pointer-events: none;
        }
        .contextual-tip.tip-top {
            top: 80px;
        }
        .contextual-tip.tip-bottom {
            bottom: 100px;
        }
        .contextual-tip.tip-info {
            background: linear-gradient(135deg, #1e3a5f, #1e293b);
            border: 1px solid #3b82f6;
        }
        .contextual-tip.tip-warning {
            background: linear-gradient(135deg, #5c4813, #1e293b);
            border: 1px solid #eab308;
        }
        .contextual-tip.tip-danger {
            background: linear-gradient(135deg, #5c1313, #1e293b);
            border: 1px solid #ef4444;
        }
        .contextual-tip.tip-success {
            background: linear-gradient(135deg, #134e2a, #1e293b);
            border: 1px solid #22c55e;
        }
        @keyframes tip-appear {
            from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        @keyframes tip-fade {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div class="w-full max-w-lg mx-auto p-4 md:p-6 relative">
        <header class="text-center mb-3">
            <h1 class="text-2xl md:text-3xl font-bold text-cyan-400">Equilibrium</h1>
            <!-- Year Progress Bar with Era Markers -->
            <div class="mt-2 px-2">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span>Year 0</span>
                    <span class="text-gray-600">|25</span>
                    <span class="text-gray-600">|50</span>
                    <span>Year 75</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2 relative">
                    <div id="year-progress-bar" class="bg-gradient-to-r from-purple-500 via-indigo-500 to-green-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    <!-- Era transition markers -->
                    <div class="absolute top-0 h-2 w-px bg-gray-500" style="left: 33.33%"></div>
                    <div class="absolute top-0 h-2 w-px bg-gray-500" style="left: 66.66%"></div>
                </div>
                <div class="flex justify-between text-xs mt-1">
                    <span class="text-purple-400 w-1/3 text-center">Traditional</span>
                    <span class="text-indigo-400 w-1/3 text-center">Transitional</span>
                    <span class="text-green-400 w-1/3 text-center">Modern</span>
                </div>
            </div>

            <!-- Anomie Warning -->
            <div id="anomie-warning" class="hidden anomie-warning mt-3 bg-red-900 border border-red-500 rounded-lg p-2">
                <p class="text-red-400 font-semibold text-sm">ANOMIE WARNING</p>
                <p class="text-red-300 text-xs">Change is outpacing moral regulation - norms are breaking down faster than new ones can form</p>
            </div>

            <!-- Isolation Warning (Egoism risk in Modern era) -->
            <div id="isolation-warning" class="hidden anomie-warning mt-3 bg-purple-900 border border-purple-500 rounded-lg p-2">
                <p class="text-purple-400 font-semibold text-sm">ISOLATION WARNING</p>
                <p class="text-purple-300 text-xs">Social bonds are dissolving - individuals are becoming disconnected from community</p>
            </div>
        </header>

        <!-- Meters -->
        <main class="space-y-2 mb-4">
            <div id="meters-container" class="space-y-2">
                <!-- Meters will be dynamically generated here -->
            </div>
        </main>

        <!-- Card -->
        <div id="card-container" class="relative min-h-56">
            <div id="card" class="card bg-gray-800 border border-gray-700 rounded-xl p-4 shadow-2xl flex flex-col justify-between min-h-56">
                <div>
                    <h3 id="card-character" class="font-semibold text-cyan-400 mb-2">Loading...</h3>
                    <p id="card-text" class="text-gray-300">The simulation is preparing the first scenario.</p>
                </div>
                <div class="flex justify-between text-center mt-4 gap-3">
                    <div id="choice-a-div" class="choice-box w-1/2 bg-gray-700 hover:bg-gray-600 border-2 border-gray-600 hover:border-cyan-500 rounded-lg p-3 min-h-16 flex flex-col justify-center transition-all">
                        <div class="text-xs text-gray-500 mb-1 md:hidden">← swipe</div>
                        <div id="choice-a-text" class="text-sm md:text-base text-gray-200 font-semibold"></div>
                    </div>
                    <div id="choice-b-div" class="choice-box w-1/2 bg-gray-700 hover:bg-gray-600 border-2 border-gray-600 hover:border-cyan-500 rounded-lg p-3 min-h-16 flex flex-col justify-center transition-all">
                        <div class="text-xs text-gray-500 mb-1 md:hidden">swipe →</div>
                        <div id="choice-b-text" class="text-sm md:text-base text-gray-200 font-semibold"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Choice Feedback Splash -->
    <div id="feedback-splash" class="fixed inset-0 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300 cursor-pointer" style="z-index: 150;">
        <div class="bg-gray-900 bg-opacity-95 border border-gray-700 rounded-xl p-5 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300 shadow-2xl">
            <p id="feedback-choice" class="text-cyan-400 font-semibold text-center mb-3"></p>
            <div id="feedback-effects" class="flex flex-wrap justify-center gap-3 mb-3">
                <!-- Effects will be inserted here -->
            </div>
            <p id="feedback-insight" class="text-gray-400 text-sm italic text-center"></p>
            <!-- Tap to continue hint (normal mode) -->
            <p id="feedback-tap-hint" class="text-gray-600 text-xs text-center mt-3 hidden">tap anywhere to continue</p>
            <!-- Tutorial explanation (hidden in normal play) -->
            <div id="feedback-tutorial-section" class="hidden mt-4 pt-4 border-t border-gray-700">
                <p id="feedback-tutorial-text" class="text-gray-300 text-sm text-center mb-4"></p>
                <button id="feedback-next-btn" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    Next →
                </button>
            </div>
        </div>
    </div>

    <!-- Era Transition Notification -->
    <div id="era-notification" class="fixed top-0 left-0 right-0 z-50 hidden">
        <div class="era-notification bg-gradient-to-r from-purple-900 to-indigo-900 border-b-2 border-purple-500 p-4 text-center">
            <h3 id="era-title" class="text-xl font-bold text-purple-300">Era Transition</h3>
            <p id="era-description" class="text-gray-300 text-sm mt-1">Your society is changing...</p>
            <p id="era-quote" class="text-purple-400 text-xs italic mt-2">"Quote from Durkheim"</p>
        </div>
    </div>

    <!-- Start Game Overlay -->
    <div id="start-overlay" class="overlay fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl shadow-xl p-8 max-w-md w-full text-center transform scale-100 transition-transform">
            <h2 class="text-4xl font-bold text-cyan-400 mb-4">Equilibrium</h2>
            <p class="text-purple-400 font-semibold mb-2">A Durkheim Solidarity Game</p>
            <p class="text-gray-300 mb-2">Guide your society through the great transition from <span class="text-purple-400">mechanical</span> to <span class="text-green-400">organic</span> solidarity.</p>
            <p class="text-gray-400 text-sm mb-4">In mechanical solidarity, people are bound by <em>similarity</em>. In organic solidarity, they're bound by <em>interdependence</em>. Your challenge: increase specialization while maintaining social cohesion.</p>
            <div class="bg-gray-700 rounded-lg p-3 mb-4 text-left text-sm">
                <p class="text-cyan-400 font-semibold mb-1">Win Condition:</p>
                <p class="text-gray-300 mb-1">Reach year 100 with:</p>
                <ul class="text-gray-400 text-xs ml-3 list-disc">
                    <li>High division of labor (specialization)</li>
                    <li>Maintained social cohesion (new bonds replace old)</li>
                    <li>Stable moral regulation (norms adapt to change)</li>
                </ul>
                <p class="text-red-400 text-xs mt-2">Beware anomie: when change outpaces moral regulation!</p>
            </div>
            <button id="start-player-game-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition-colors w-full text-lg mb-3">
                Begin the Transition
            </button>
            <button id="view-leaderboard-btn" class="bg-gray-700 hover:bg-gray-600 text-gray-300 font-semibold py-2 px-4 rounded-lg transition-colors w-full text-sm">
                Your Scores
            </button>
        </div>
    </div>

    <!-- Game Over Modal (Collapse) -->
    <div id="game-over-modal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 opacity-0 invisible">
        <div class="bg-gray-800 rounded-2xl shadow-xl p-6 max-w-md w-full text-center transform scale-95 transition-transform">
            <h2 class="text-3xl font-bold text-red-500 mb-2" id="collapse-title">Societal Collapse!</h2>
            <p class="text-gray-400 mb-2">You guided society for <span id="final-year" class="font-bold text-white">0</span> years.</p>
            <p id="collapse-reason" class="text-lg text-cyan-400 font-semibold mb-3"></p>

            <!-- Reflection Section -->
            <div class="bg-gray-700 rounded-lg p-4 mb-4 text-left">
                <p class="text-purple-400 font-semibold text-sm mb-2">Reflection:</p>
                <p id="reflection-question" class="text-gray-300 text-sm mb-2"></p>
                <p id="durkheim-quote" class="text-gray-400 text-xs italic border-l-2 border-purple-500 pl-3"></p>
            </div>

            <div class="flex gap-2">
                <button id="play-again-btn" class="flex-1 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    Try Again
                </button>
                <button id="collapse-leaderboard-btn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-gray-300 font-semibold py-2 px-4 rounded-lg transition-colors">
                    Your Scores
                </button>
            </div>
        </div>
    </div>

    <!-- Victory Modal -->
    <div id="victory-modal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 opacity-0 invisible">
        <div class="bg-gradient-to-b from-gray-800 to-green-900 rounded-2xl shadow-xl p-6 max-w-md w-full text-center transform scale-95 transition-transform border border-green-500">
            <h2 class="text-3xl font-bold text-green-400 mb-2">Organic Solidarity Achieved!</h2>
            <p class="text-gray-300 mb-2">You successfully navigated the great transformation!</p>
            <p class="text-gray-400 mb-4">Final Year: <span id="victory-year" class="font-bold text-white">2100</span></p>

            <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4 mb-4 text-left">
                <p class="text-green-400 font-semibold text-sm mb-2">What You Accomplished:</p>
                <p class="text-gray-300 text-sm mb-2">Your society developed a complex division of labor while maintaining social cohesion. People are now bound together by their <em>interdependence</em> rather than their <em>similarity</em>.</p>
                <p class="text-gray-400 text-xs italic">"The division of labor is the source of civilization... it creates among men a system of rights and duties which binds them together in a durable way." - Durkheim</p>
            </div>

            <div class="mb-4">
                <label class="text-gray-400 text-sm block mb-1">Enter your name to save your score:</label>
                <input type="text" id="winner-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:border-green-500 focus:outline-none" placeholder="Your name" maxlength="20">
            </div>

            <button id="submit-score-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition-colors w-full">
                Save Score
            </button>
        </div>
    </div>

    <!-- Your Scores Modal -->
    <div id="leaderboard-modal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 opacity-0 invisible">
        <div class="bg-gray-800 rounded-2xl shadow-xl p-6 max-w-md w-full text-center transform scale-95 transition-transform">
            <h2 class="text-2xl font-bold text-cyan-400 mb-4">Your Scores</h2>
            <div id="leaderboard-content" class="mb-4 max-h-64 overflow-y-auto">
                <!-- Score entries will be inserted here -->
            </div>
            <button id="close-leaderboard-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg transition-colors w-full">
                Close
            </button>
        </div>
    </div>

    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay" class="tutorial-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-2 md:p-4 opacity-0 invisible transition-all duration-300" style="z-index: 200;">
        <div class="bg-gray-800 border border-cyan-500 rounded-xl shadow-xl p-4 md:p-6 max-w-md w-full transform scale-95 transition-transform">
            <div class="flex justify-between items-center mb-2 md:mb-3">
                <h3 id="tutorial-title" class="text-base md:text-xl font-bold text-cyan-400">Tutorial</h3>
                <div class="tutorial-progress" id="tutorial-progress">
                    <div class="tutorial-progress-dot"></div>
                    <div class="tutorial-progress-dot"></div>
                    <div class="tutorial-progress-dot"></div>
                    <div class="tutorial-progress-dot"></div>
                    <div class="tutorial-progress-dot"></div>
                </div>
            </div>
            <div id="tutorial-content" class="tutorial-content text-gray-300 text-xs md:text-sm mb-3 md:mb-4 max-h-48 md:max-h-64 overflow-y-auto">
                <!-- Tutorial content inserted here -->
            </div>
            <div class="flex gap-2">
                <button id="tutorial-skip-btn" class="bg-gray-700 hover:bg-gray-600 text-gray-400 py-2 px-3 rounded-lg transition-colors text-xs">
                    Skip
                </button>
                <button id="tutorial-continue-btn" class="flex-1 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm md:text-base">
                    Continue →
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- HEROICONS (MIT Licensed) ---
        // Inline SVGs for consistent, dependency-free icons
        const icons = {
            // Meter icons
            solidarity: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z" /></svg>`,
            productivity: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 6.087c0-.355.186-.676.401-.959.221-.29.349-.634.349-1.003 0-1.036-1.007-1.875-2.25-1.875s-2.25.84-2.25 1.875c0 .369.128.713.349 1.003.215.283.401.604.401.959v0a.64.64 0 0 1-.657.643 48.39 48.39 0 0 1-4.163-.3c.186 1.613.293 3.25.315 4.907a.656.656 0 0 1-.658.663v0c-.355 0-.676-.186-.959-.401a1.647 1.647 0 0 0-1.003-.349c-1.036 0-1.875 1.007-1.875 2.25s.84 2.25 1.875 2.25c.369 0 .713-.128 1.003-.349.283-.215.604-.401.959-.401v0c.31 0 .555.26.532.57a48.039 48.039 0 0 1-.642 5.056c1.518.19 3.058.309 4.616.354a.64.64 0 0 0 .657-.643v0c0-.355-.186-.676-.401-.959a1.647 1.647 0 0 1-.349-1.003c0-1.035 1.008-1.875 2.25-1.875 1.243 0 2.25.84 2.25 1.875 0 .369-.128.713-.349 1.003-.215.283-.4.604-.4.959v0c0 .333.277.599.61.58a48.1 48.1 0 0 0 5.427-.63 48.05 48.05 0 0 0 .582-4.717.532.532 0 0 0-.533-.57v0c-.355 0-.676.186-.959.401-.29.221-.634.349-1.003.349-1.035 0-1.875-1.007-1.875-2.25s.84-2.25 1.875-2.25c.37 0 .713.128 1.003.349.283.215.604.401.96.401v0a.656.656 0 0 0 .658-.663 48.422 48.422 0 0 0-.37-5.36c-1.886.342-3.81.574-5.766.689a.578.578 0 0 1-.61-.58v0Z" /></svg>`,
            legitimacy: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 10.032a48.36 48.36 0 0 0-7.5.3V21M3 21h18M12 6.75h.008v.008H12V6.75Z" /></svg>`,
            innovation: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.383a14.406 14.406 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18" /></svg>`,
            // Warning/tip icons
            warning: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>`,
            isolation: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>`,
            target: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon"><path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672 13.684 16.6m0 0-2.51 2.225.569-9.47 5.227 7.917-3.286-.672Zm-7.518-.267A8.25 8.25 0 1 1 20.25 10.5M8.288 14.212A5.25 5.25 0 1 1 17.25 10.5" /></svg>`
        };

        // Helper to get icon with custom size class
        function getIcon(name, sizeClass = 'w-5 h-5') {
            const svg = icons[name] || icons.warning;
            return svg.replace('class="icon"', `class="icon ${sizeClass} inline-block"`);
        }

        // --- DOM ELEMENTS ---
        const metersContainerEl = document.getElementById('meters-container');
        const cardContainerEl = document.getElementById('card-container');
        const cardEl = document.getElementById('card');
        const cardCharacterEl = document.getElementById('card-character');
        const cardTextEl = document.getElementById('card-text');
        const choiceADiv = document.getElementById('choice-a-div');
        const choiceBDiv = document.getElementById('choice-b-div');
        const choiceATextEl = document.getElementById('choice-a-text');
        const choiceBTextEl = document.getElementById('choice-b-text');
        const gameOverModalEl = document.getElementById('game-over-modal');
        const finalYearEl = document.getElementById('final-year');
        const collapseReasonEl = document.getElementById('collapse-reason');
        const playAgainBtn = document.getElementById('play-again-btn');
        const startOverlayEl = document.getElementById('start-overlay');
        const startPlayerGameBtn = document.getElementById('start-player-game-btn');

        // New DOM Elements
        const anomieWarningEl = document.getElementById('anomie-warning');
        const isolationWarningEl = document.getElementById('isolation-warning');
        const eraNotificationEl = document.getElementById('era-notification');
        const eraTitleEl = document.getElementById('era-title');
        const eraDescriptionEl = document.getElementById('era-description');
        const eraQuoteEl = document.getElementById('era-quote');
        const reflectionQuestionEl = document.getElementById('reflection-question');
        const durkheimQuoteEl = document.getElementById('durkheim-quote');
        const victoryModalEl = document.getElementById('victory-modal');
        const victoryYearEl = document.getElementById('victory-year');
        const winnerNameEl = document.getElementById('winner-name');
        const submitScoreBtn = document.getElementById('submit-score-btn');
        const leaderboardModalEl = document.getElementById('leaderboard-modal');
        const leaderboardContentEl = document.getElementById('leaderboard-content');
        const viewLeaderboardBtn = document.getElementById('view-leaderboard-btn');
        const closeLeaderboardBtn = document.getElementById('close-leaderboard-btn');
        const collapseLeaderboardBtn = document.getElementById('collapse-leaderboard-btn');

        // Feedback splash elements
        const feedbackSplashEl = document.getElementById('feedback-splash');
        const feedbackChoiceEl = document.getElementById('feedback-choice');
        const feedbackEffectsEl = document.getElementById('feedback-effects');
        const feedbackInsightEl = document.getElementById('feedback-insight');
        const feedbackTutorialSection = document.getElementById('feedback-tutorial-section');
        const feedbackTutorialText = document.getElementById('feedback-tutorial-text');
        const feedbackNextBtn = document.getElementById('feedback-next-btn');

        // Tutorial elements
        const tutorialOverlayEl = document.getElementById('tutorial-overlay');
        const tutorialTitleEl = document.getElementById('tutorial-title');
        const tutorialContentEl = document.getElementById('tutorial-content');
        const tutorialProgressEl = document.getElementById('tutorial-progress');
        const tutorialSkipBtn = document.getElementById('tutorial-skip-btn');
        const tutorialContinueBtn = document.getElementById('tutorial-continue-btn');

        // --- API CONFIGURATION ---
        // Auto-detect API URL: use relative path in production, localhost in development
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3001/api'
            : '/api';

        // --- GAME DATA ---
        let cardData = null;
        let cardsLoaded = false;

        // Load cards from JSON files
        async function loadCards() {
            try {
                // Load both card files
                const [mainResponse, newResponse] = await Promise.all([
                    fetch('cards.json'),
                    fetch('new-cards.json')
                ]);

                const mainCards = await mainResponse.json();
                const newCards = await newResponse.json();

                // Merge the card arrays
                cardData = {
                    traditional: [...mainCards.traditional, ...newCards.traditional],
                    transitional: [...mainCards.transitional, ...newCards.transitional],
                    modern: [...mainCards.modern, ...newCards.modern],
                    universal: [...mainCards.universal, ...newCards.universal]
                };

                cardsLoaded = true;
                console.log('Cards loaded:', {
                    traditional: cardData.traditional.length,
                    transitional: cardData.transitional.length,
                    modern: cardData.modern.length,
                    universal: cardData.universal.length
                });
            } catch (error) {
                console.error('Failed to load cards:', error);
                // Fallback to empty arrays if load fails
                cardData = { traditional: [], transitional: [], modern: [], universal: [] };
            }
        }

        // Get available cards based on current era
        function getAvailableCards() {
            if (!cardData) return [];

            const era = state.currentEra;
            let available = [];

            // Add era-appropriate cards
            if (era === 'traditional') {
                // Traditional era: only traditional cards (no modern concepts)
                available = [...cardData.traditional];
            } else if (era === 'transitional') {
                // Transitional era: transitional + some traditional + universal
                available = [...cardData.transitional];
                available = available.concat(cardData.universal);
                // Add some traditional cards (society remembers its past)
                const traditionalSample = cardData.traditional.slice(0, Math.floor(cardData.traditional.length / 3));
                available = available.concat(traditionalSample);
            } else if (era === 'modern') {
                // Modern era: modern + transitional + universal
                available = [...cardData.modern];
                available = available.concat(cardData.transitional);
                available = available.concat(cardData.universal);
            }

            return available;
        }

        const meterDefinitions = {
            solidarity: {
                name: "Social Cohesion",
                iconKey: "solidarity",
                tooltip: "The bonds holding society together. In mechanical solidarity, this comes from similarity. In organic solidarity, from interdependence. Too low = fragmentation. Too high = resistance to change."
            },
            productivity: {
                name: "Division of Labor",
                iconKey: "productivity",
                tooltip: "Economic specialization and complexity. As people take different jobs, they become interdependent. This is the engine of social change - but it must be balanced with cohesion."
            },
            legitimacy: {
                name: "Moral Regulation",
                iconKey: "legitimacy",
                tooltip: "The strength of norms and institutional trust. When change outpaces regulation, anomie (normlessness) emerges. New rules must form to match new social structures."
            },
            innovation: {
                name: "Social Differentiation",
                iconKey: "innovation",
                tooltip: "Individual difference and cultural diversity. Organic solidarity requires each person to have their own sphere. Too little = stagnation. Too much without integration = chaos."
            }
        };

        // Era-specific labels for the solidarity meter - teaches that the NATURE of cohesion changes
        const solidarityMeterByEra = {
            traditional: {
                name: "Collective Conscience",
                tooltip: "Shared beliefs and values binding your people together. In Durkheim's terms, the collective conscience 'envelops' individual identity. This is the foundation of mechanical solidarity."
            },
            transitional: {
                name: "Social Bonds",
                tooltip: "The ties holding society together are transforming. Old bonds of similarity weaken while new bonds of interdependence form. A precarious but necessary passage."
            },
            modern: {
                name: "Interdependence",
                tooltip: "People are bound together by mutual reliance - they need each other's specialized contributions. This functional interdependence IS organic solidarity."
            }
        };

        // --- TUTORIAL DATA ---
        const tutorialCards = [
            {
                character: "Council Elder",
                text: "Our village gathers for the first time. The elders ask: what makes us a community?",
                choiceA: {
                    text: "Our shared traditions",
                    effects: { solidarity: 8, legitimacy: 3, productivity: -2, innovation: -2 },
                    feedback: "Emphasizing shared traditions strengthens bonds but may limit economic growth. This is <strong>mechanical solidarity</strong> - unity through similarity."
                },
                choiceB: {
                    text: "Working together",
                    effects: { solidarity: 5, legitimacy: 2, productivity: 3, innovation: 2 },
                    feedback: "Focusing on cooperation opens the door to specialization. You're planting seeds for <strong>organic solidarity</strong> - unity through interdependence."
                },
                lesson: {
                    title: "Social Cohesion",
                    content: `<strong class="text-cyan-400">Social Cohesion</strong> measures the bonds holding your society together.<br><br>Too low → society fragments. Too high → resistance to change.<br><br>This is your most important meter. Watch it closely!`,
                    highlight: "meters"
                }
            },
            {
                character: "Village Craftsman",
                text: "Should everyone farm, or should some specialize in pottery, weaving, and metalwork?",
                choiceA: {
                    text: "Everyone should farm first",
                    effects: { solidarity: 3, legitimacy: 2, productivity: -3, innovation: -2 },
                    feedback: "Keeping everyone in the same role maintains similarity and cohesion, but slows the <strong>division of labor</strong> that drives social evolution."
                },
                choiceB: {
                    text: "Let people specialize",
                    effects: { solidarity: -2, legitimacy: 1, productivity: 6, innovation: 4 },
                    feedback: "Specialization increases productivity and innovation! But notice: solidarity dropped slightly. As people become different, old bonds weaken."
                },
                lesson: {
                    title: "Division of Labor",
                    content: `<strong class="text-cyan-400">Division of Labor</strong> measures economic specialization.<br><br>As people take different jobs, they become <em>interdependent</em> - they need each other.<br><br>This is the engine of social change!`,
                    highlight: "meters"
                }
            },
            {
                character: "Tribal Philosopher",
                text: "The young ask: what truly binds us together?",
                choiceA: {
                    text: "We are one family, one blood",
                    effects: { solidarity: 6, legitimacy: 3, productivity: -2, innovation: -3 },
                    feedback: "This reinforces <strong class='text-purple-400'>mechanical solidarity</strong>. Strong collective conscience, but it may resist the changes needed for modernization."
                },
                choiceB: {
                    text: "Each person's work serves all",
                    effects: { solidarity: 2, legitimacy: 2, productivity: 4, innovation: 3 },
                    feedback: "This points toward <strong class='text-green-400'>organic solidarity</strong>! People are bound not by sameness, but by needing each other's different contributions."
                },
                lesson: {
                    title: "The Great Transition",
                    content: `<strong class="text-purple-400">Mechanical solidarity</strong> = unity through <em>similarity</em>.<br><br><strong class="text-green-400">Organic solidarity</strong> = unity through <em>interdependence</em>.<br><br><strong>Your goal:</strong> Transform society from one to the other.`,
                    highlight: "solidarity"
                }
            },
            {
                character: "Worried Elder",
                text: "Change comes faster than our customs can adapt. Some abandon the old ways before new ones take hold.",
                choiceA: {
                    text: "Slow down, preserve traditions",
                    effects: { solidarity: 4, legitimacy: 5, productivity: -3, innovation: -2 },
                    feedback: "Preserving traditions strengthens <strong>moral regulation</strong> - the rules and norms that guide behavior. This protects against anomie, but slows progress."
                },
                choiceB: {
                    text: "Push forward, embrace change",
                    effects: { solidarity: -3, legitimacy: -3, productivity: 5, innovation: 4 },
                    feedback: "Rapid change boosts productivity but weakens both solidarity AND legitimacy. This is exactly how <strong class='text-red-400'>anomie</strong> develops!"
                },
                lesson: {
                    title: "Danger: Anomie",
                    content: `<strong class="text-red-400">Anomie</strong> = "normlessness" when change is too fast.<br><br>If the warning appears, a new meter (<strong class="text-cyan-400">Moral Regulation</strong>) will be revealed to help you stabilize.<br><br>Balance progress with stability!`,
                    highlight: "anomie"
                }
            },
            {
                character: "The Path Ahead",
                text: "Your society stands at a crossroads. The journey to organic solidarity will take 100 years.",
                choiceA: {
                    text: "Build strong foundations",
                    effects: { solidarity: 4, legitimacy: 4, productivity: 2, innovation: 1 },
                    feedback: "A balanced start! Strong foundations help weather the turbulent transition period ahead. You're ready for the journey."
                },
                choiceB: {
                    text: "Embrace specialization",
                    effects: { solidarity: 1, legitimacy: 2, productivity: 5, innovation: 4 },
                    feedback: "An ambitious start toward organic solidarity! Higher risk, but faster progress. Watch your cohesion carefully."
                },
                lesson: {
                    title: "Your Mission",
                    content: `<strong>Win:</strong> Reach Year 100 with organic solidarity.<br><br>As society grows complex, new meters will appear:<br>• <strong class="text-cyan-400">Moral Regulation</strong> - when anomie threatens<br>• <strong class="text-cyan-400">Social Differentiation</strong> - in the Transitional era<br><br>Good luck!`,
                    highlight: "none"
                }
            }
        ];

        // --- QUESTLINE CARDS ---
        // Follow-up cards triggered by previous choices
        // These show that social change is a process, not a single event
        const triggeredCards = {
            // Professional Bodies questline
            "guild_formation_success": {
                character: "Guild Master",
                text: "The professional associations you sanctioned have flourished. They now seek official recognition and the power to set standards for their trades.",
                questline: "professional_bodies",
                choiceA: {
                    text: "Grant them regulatory power",
                    effects: { solidarity: 5, legitimacy: 8, productivity: 3, innovation: -2 },
                    triggers: [{ cardId: "guild_monopoly", delay: 8 }]
                },
                choiceB: {
                    text: "Keep them advisory only",
                    effects: { solidarity: 2, legitimacy: 3, productivity: 5, innovation: 4 }
                }
            },
            "guild_monopoly": {
                character: "Young Entrepreneur",
                text: "The guilds have become gatekeepers. Talented outsiders cannot practice their crafts without guild approval. Innovation suffers as new methods are blocked.",
                questline: "professional_bodies",
                choiceA: {
                    text: "Break the guild monopolies",
                    effects: { solidarity: -6, legitimacy: -4, productivity: 5, innovation: 8 }
                },
                choiceB: {
                    text: "Reform from within",
                    effects: { solidarity: 2, legitimacy: 4, productivity: 2, innovation: 3 }
                }
            },

            // Factory System questline
            "factory_conditions": {
                character: "Factory Inspector",
                text: "The factories you permitted have grown. Reports emerge of dangerous conditions - long hours, child labor, injuries. Workers organize in secret.",
                questline: "factory_system",
                choiceA: {
                    text: "Mandate safety regulations",
                    effects: { solidarity: 4, legitimacy: 6, productivity: -3, innovation: 2 },
                    triggers: [{ cardId: "factory_compliance", delay: 6 }]
                },
                choiceB: {
                    text: "Let the market self-regulate",
                    effects: { solidarity: -5, legitimacy: -3, productivity: 6, innovation: 3 },
                    triggers: [{ cardId: "factory_strike", delay: 4 }]
                }
            },
            "factory_strike": {
                character: "Strike Leader",
                text: "Workers have walked out! Production halts across the industrial district. They demand better conditions or they won't return.",
                questline: "factory_system",
                choiceA: {
                    text: "Negotiate with workers",
                    effects: { solidarity: 6, legitimacy: 4, productivity: -2, innovation: 2 }
                },
                choiceB: {
                    text: "Bring in replacement workers",
                    effects: { solidarity: -8, legitimacy: -5, productivity: 3, innovation: -2 }
                }
            },
            "factory_compliance": {
                character: "Factory Owner",
                text: "Your safety regulations have reduced injuries, but owners complain of costs. Some factories have moved to unregulated territories.",
                questline: "factory_system",
                choiceA: {
                    text: "Strengthen enforcement",
                    effects: { solidarity: 3, legitimacy: 5, productivity: -4, innovation: 1 }
                },
                choiceB: {
                    text: "Offer compliance incentives",
                    effects: { solidarity: 2, legitimacy: 3, productivity: 2, innovation: 3 }
                }
            },

            // Education Reform questline
            "education_results": {
                character: "School Inspector",
                text: "A generation has passed since your education reforms. Literacy has spread, but so have new ideas that challenge traditional authority.",
                questline: "education",
                choiceA: {
                    text: "Embrace the enlightened citizenry",
                    effects: { solidarity: -2, legitimacy: 3, productivity: 5, innovation: 7 },
                    triggers: [{ cardId: "education_division", delay: 10 }]
                },
                choiceB: {
                    text: "Refocus on moral instruction",
                    effects: { solidarity: 5, legitimacy: 4, productivity: 2, innovation: -3 }
                }
            },
            "education_division": {
                character: "University Dean",
                text: "Education has created a divide. The educated elite speak differently, dress differently, think differently. Are they still part of the same society?",
                questline: "education",
                choiceA: {
                    text: "Expand education to all",
                    effects: { solidarity: 4, legitimacy: 5, productivity: 4, innovation: 5 }
                },
                choiceB: {
                    text: "Preserve educational hierarchy",
                    effects: { solidarity: -3, legitimacy: 2, productivity: 3, innovation: 2 }
                }
            },

            // Migration questline
            "migrant_community": {
                character: "Migrant Elder",
                text: "The workers who came to your factories have formed their own neighborhood. They maintain their old customs but their children speak the local tongue.",
                questline: "migration",
                choiceA: {
                    text: "Support cultural integration",
                    effects: { solidarity: 5, legitimacy: 3, productivity: 3, innovation: 4 }
                },
                choiceB: {
                    text: "Encourage distinct communities",
                    effects: { solidarity: -2, legitimacy: 2, productivity: 4, innovation: 6 },
                    triggers: [{ cardId: "migrant_tension", delay: 7 }]
                }
            },
            "migrant_tension": {
                character: "Local Merchant",
                text: "Tensions rise between old residents and newer communities. A dispute over market stalls threatens to turn violent.",
                questline: "migration",
                choiceA: {
                    text: "Create shared civic institutions",
                    effects: { solidarity: 6, legitimacy: 5, productivity: 2, innovation: 2 }
                },
                choiceB: {
                    text: "Let communities govern themselves",
                    effects: { solidarity: -4, legitimacy: -2, productivity: 3, innovation: 4 }
                }
            }
        };

        // Era definitions for Durkheim's transition
        const eras = {
            traditional: {
                name: "Traditional Era",
                color: "bg-purple-600",
                description: "Society based on similarity and shared beliefs"
            },
            transitional: {
                name: "Transitional Era",
                color: "bg-indigo-600",
                description: "Old bonds weakening, new forms emerging"
            },
            modern: {
                name: "Modern Era",
                color: "bg-green-600",
                description: "Interdependence through specialization"
            }
        };

        // Era transition messages
        const eraTransitions = {
            toTransitional: {
                title: "The Division of Labor Emerges",
                description: "Specialization is increasing. The old bonds of similarity weaken as people take on different roles. New forms of interdependence must emerge - or anomie threatens.",
                quote: "\"The division of labor varies in direct ratio with the volume and density of societies.\" - Durkheim"
            },
            toModern: {
                title: "Organic Solidarity Developing",
                description: "Specialized roles create mutual dependence. Society now coheres through difference, not sameness. Professional groups and contracts replace kinship and tradition.",
                quote: "\"Each individual is the more closely dependent upon society the more divided labor is.\" - Durkheim"
            },
            toTraditional: {
                title: "Return to Mechanical Solidarity",
                description: "Society retreats to simpler organization. The collective conscience strengthens as individual differences diminish. Unity through similarity is restored.",
                quote: "\"In mechanical solidarity, the collective conscience completely envelops our whole conscience.\" - Durkheim"
            }
        };

        // --- GAME STATE ---
        let state;
        let simInterval;
        const WIN_YEAR = 75;
        const STARTING_YEAR = 0;

        // Era transition years - equal thirds for educational pacing
        const ERA_TRANSITIONS = {
            transitional: 25,  // Year 25: Traditional → Transitional
            modern: 50         // Year 50: Transitional → Modern
        };

        // Theory-driven requirements for era transitions
        const ERA_REQUIREMENTS = {
            transitional: {
                // Durkheim: Division of labor must begin emerging
                productivity: 45,
                failureTitle: "Society Stagnated",
                failureMessage: "Without emerging specialization, the great transition cannot begin. Durkheim showed that division of labor is the engine of social evolution—your society remained trapped in undifferentiated tradition."
            },
            modern: {
                // Durkheim: Organic solidarity requires specialization WITH maintained bonds
                productivity: 70,  // Division of labor must be dominant
                solidarity: 40,    // Slightly higher bar for maintained bonds
                noAnomie: true,
                failureTitle: "The Transition Failed",
                failureMessages: {
                    productivity: "Incomplete Transition: The division of labor never developed enough to create true interdependence. Organic solidarity requires specialized roles that need each other.",
                    solidarity: "Bonds Dissolved Before New Ones Formed: High specialization without maintained cohesion leads to fragmentation, not organic solidarity. Durkheim warned this is anomic, not organic.",
                    anomie: "Trapped in Normlessness: Your society couldn't establish new moral regulation to match its changed structures. Without norms, there is no solidarity—only chaos."
                }
            }
        };

        function initializeMeters() {
            metersContainerEl.innerHTML = '';
            Object.keys(meterDefinitions).forEach(key => {
                const meterInfo = meterDefinitions[key];
                const meterEl = document.createElement('div');
                meterEl.id = `meter-${key}`;
                meterEl.className = 'meter-container transition-all duration-500 overflow-hidden cursor-help';
                meterEl.title = meterInfo.tooltip;
                meterEl.innerHTML = `
                    <div class="flex justify-between items-center mb-0.5">
                        <div class="flex items-center">
                            <span id="icon-${key}" class="status-icon mr-1">${getIcon(meterInfo.iconKey, 'w-4 h-4')}</span>
                            <span class="font-semibold text-sm">${meterInfo.name}</span>
                            <span class="text-gray-500 text-xs ml-1 hidden md:inline">ⓘ</span>
                        </div>
                        <span id="value-${key}" class="font-mono text-sm">50%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-3">
                        <div id="bar-${key}" class="progress-bar-fill bg-cyan-500 h-3 rounded-full" style="width: 50%"></div>
                    </div>
                `;
                metersContainerEl.appendChild(meterEl);
            });
        }

        // Progressive meter reveal system
        function updateMeterVisibility() {
            const meters = ['solidarity', 'productivity', 'legitimacy', 'innovation'];
            meters.forEach(key => {
                const meterEl = document.getElementById(`meter-${key}`);
                if (meterEl) {
                    if (state.visibleMeters[key]) {
                        meterEl.style.maxHeight = '60px';
                        meterEl.style.opacity = '1';
                        meterEl.style.marginBottom = '';
                    } else {
                        meterEl.style.maxHeight = '0';
                        meterEl.style.opacity = '0';
                        meterEl.style.marginBottom = '0';
                    }
                }
            });
        }

        function revealMeter(meterKey, showNotification = true) {
            if (state.visibleMeters[meterKey]) return; // Already visible

            state.visibleMeters[meterKey] = true;
            updateMeterVisibility();

            if (showNotification && state.gameMode === 'player') {
                const meterInfo = meterDefinitions[meterKey];
                showMeterRevealNotification(meterInfo.name, meterInfo.iconKey);
            }
        }

        function showMeterRevealNotification(name, iconKey) {
            // Create a brief notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-cyan-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-pulse flex items-center';
            notification.innerHTML = `<span class="mr-2">${getIcon(iconKey, 'w-5 h-5')}</span> New meter: <strong>${name}</strong>`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => notification.remove(), 500);
            }, 2500);
        }

        // Contextual tip system - non-blocking hints that appear when relevant
        const contextualTips = {
            meterWarning: {
                solidarity: { iconKey: 'solidarity', title: 'Cohesion Weakening', text: 'Social bonds are straining. In Durkheim\'s terms, your collective conscience is fragmenting.' },
                productivity: { iconKey: 'productivity', title: 'Rapid Specialization', text: 'Division of labor is accelerating. This creates interdependence—but can outpace moral regulation.' },
                legitimacy: { iconKey: 'legitimacy', title: 'Norms Under Pressure', text: 'Moral regulation is struggling. When rules lose legitimacy, anomie threatens.' },
                innovation: { iconKey: 'innovation', title: 'Differentiation Spreading', text: 'Individual differences are multiplying. Diversity needs integration to become solidarity.' }
            },
            meterDanger: {
                solidarity: { iconKey: 'solidarity', title: 'Solidarity Critical!', text: 'Society is fragmenting. Without bonds—mechanical or organic—collapse follows.' },
                productivity: { iconKey: 'productivity', title: 'Runaway Specialization!', text: 'Change is outpacing society\'s ability to integrate. The worker becomes a cog.' },
                legitimacy: { iconKey: 'legitimacy', title: 'Moral Vacuum!', text: 'Norms have lost their force. Durkheim warned: the market alone cannot ensure order.' },
                innovation: { iconKey: 'innovation', title: 'Chaos of Difference!', text: 'Differentiation without direction. Society has diversity but no coherence.' }
            },
            firstChoice: {
                iconKey: 'target', title: 'Your First Decision', text: 'Each choice shapes your society. Watch how the meters respond—and remember, balance is key.'
            },
            anomie: {
                iconKey: 'warning', title: 'Anomie Emerging', text: 'Durkheim\'s key concept: when change outpaces moral regulation, norms break down. Stabilize or face collapse.'
            },
            isolation: {
                iconKey: 'isolation', title: 'Isolation Risk (Egoism)', text: 'Durkheim warned: modern societies with weak social bonds produce "egoistic" individuals—disconnected and adrift. Rebuild community ties!'
            }
        };

        function showContextualTip(tipData, type = 'info', position = 'top', duration = 4000) {
            // Don't show tips in sim mode
            if (state.gameMode !== 'player') return;

            const tip = document.createElement('div');
            tip.className = `contextual-tip tip-${position} tip-${type}`;
            tip.innerHTML = `
                <div class="flex items-start gap-3">
                    <span class="flex-shrink-0">${getIcon(tipData.iconKey, 'w-6 h-6')}</span>
                    <div>
                        <p class="font-semibold text-white text-sm">${tipData.title}</p>
                        <p class="text-gray-300 text-xs mt-1">${tipData.text}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(tip);

            // Auto-remove after duration
            setTimeout(() => {
                tip.style.animation = 'tip-fade 0.3s ease-out forwards';
                setTimeout(() => tip.remove(), 300);
            }, duration);
        }

        function resetGame(mode = 'sim', startTutorial = false) {
            // Start as a mechanical solidarity society
            // For player mode: start with only core meters visible
            const showAllMeters = (mode === 'sim');
            state = {
                year: STARTING_YEAR,
                meters: {
                    solidarity: 80,    // Very high - Mechanical Solidarity binds tightly
                    productivity: 20,  // Very low - pre-industrial, minimal division of labor
                    legitimacy: 70,    // High - Repressive law is absolute
                    innovation: 15     // Very low - individuality absorbed by collective
                },
                visibleMeters: {
                    solidarity: true,                    // Always visible (core)
                    productivity: true,                  // Always visible (core)
                    legitimacy: showAllMeters,           // Revealed with anomie warning
                    innovation: showAllMeters            // Revealed in transitional era
                },
                gameOver: false,
                gameMode: mode,
                usedCardKeys: [],      // Track cards by character+text key
                currentEra: 'traditional',
                hasReachedTransitional: false,
                hasReachedModern: false,
                inAnomie: false,
                inIsolation: false,        // Egoism risk - low solidarity in Modern era
                // Durkheimian mechanics
                anomieTurns: 0,            // Sustained anomie leads to collapse
                isolationTurns: 0,         // Sustained isolation leads to egoistic collapse
                anomieResistance: 0,       // Occupational groups stabilize modern society
                // Tutorial state
                inTutorial: startTutorial,
                tutorialStep: 0,           // Current tutorial card (0-4)
                // Questline system
                pendingCards: [],          // Cards triggered by previous choices [{cardId, triggerYear}]
                questlineHistory: [],      // Track which questlines have been triggered
                choicesSwapped: false,     // Randomize choice positions to prevent pattern-matching
                // Contextual first-time hints (replaces blocking tutorial)
                firstTimeHints: {
                    meterWarning: { solidarity: false, productivity: false, legitimacy: false, innovation: false },
                    meterDanger: { solidarity: false, productivity: false, legitimacy: false, innovation: false },
                    anomie: false,
                    isolation: false,
                    eraTransitional: false,
                    eraModern: false,
                    firstChoice: false
                }
            };

            gameOverModalEl.classList.add('opacity-0', 'invisible');
            gameOverModalEl.querySelector('div').classList.add('scale-95');
            victoryModalEl.classList.add('opacity-0', 'invisible');
            victoryModalEl.querySelector('div').classList.add('scale-95');
            anomieWarningEl.classList.add('hidden');
            isolationWarningEl.classList.add('hidden');

            // Reset feedback splash
            hideFeedbackSplash();
            feedbackTutorialSection.classList.add('hidden');
            feedbackInsightEl.classList.remove('hidden');

            if (simInterval) clearInterval(simInterval);

            if (mode === 'sim') {
                cardContainerEl.classList.remove('player-turn');
                simInterval = setInterval(runSimTurn, 3500);
            } else {
                cardContainerEl.classList.add('player-turn');
            }

            updateUI();
            updateEra();
            updateMeterVisibility();
            updateSolidarityMeterLabel(); // Set era-appropriate label for solidarity meter

            // Only display card if not starting tutorial (tutorial handles its own card display)
            if (!startTutorial) {
                setTimeout(displayCard, 500);
            }
        }

        // Calculate solidarity type (0 = mechanical, 100 = organic)
        // Key Durkheim insight: Organic solidarity requires BOTH high division of labor AND maintained social cohesion
        // It's not about destroying old bonds, but transforming them
        function calculateSolidarityScore() {
            const { solidarity, productivity, innovation } = state.meters;

            // Division of labor (specialization) - primary driver of organic solidarity
            const divisionOfLabor = (productivity + innovation) / 2;

            // Organic solidarity emerges when:
            // 1. High division of labor (specialization creates interdependence)
            // 2. Social cohesion is maintained (new forms of integration replace old)
            // You can't achieve organic solidarity by just destroying traditional bonds!

            // Score based primarily on division of labor, but penalized if cohesion collapses
            let score = divisionOfLabor;

            // If cohesion is too low, you're not achieving organic solidarity - you're in anomie
            // Organic solidarity requires interdependence to CREATE new bonds
            if (solidarity < 30) {
                // Low cohesion + high specialization = anomic, not organic
                score = Math.min(score, 50 + (solidarity - 30));
            }

            return Math.min(100, Math.max(0, score));
        }

        function getSolidarityType() {
            const score = calculateSolidarityScore();
            const { solidarity, productivity, innovation } = state.meters;
            const divisionOfLabor = (productivity + innovation) / 2;

            // Check for anomic condition (high specialization but low cohesion)
            if (divisionOfLabor > 50 && solidarity < 30) {
                return {
                    type: 'anomic',
                    label: 'Anomic State',
                    color: 'text-red-400',
                    description: 'Specialization without integration - normlessness threatens'
                };
            }

            if (score < 35) return {
                type: 'mechanical',
                label: 'Mechanical Solidarity',
                color: 'text-purple-400',
                description: 'Unity through similarity - collective conscience dominates'
            };
            if (score < 50) return {
                type: 'transitioning-from-mechanical',
                label: 'Weakening Mechanical',
                color: 'text-indigo-400',
                description: 'Division of labor emerging, traditional bonds adapting'
            };
            if (score < 65) return {
                type: 'transitional',
                label: 'In Transition',
                color: 'text-cyan-400',
                description: 'Old and new forms of solidarity coexisting'
            };
            if (score < 80) return {
                type: 'transitioning-to-organic',
                label: 'Emerging Organic',
                color: 'text-teal-400',
                description: 'Interdependence creating new forms of social bonds'
            };
            return {
                type: 'organic',
                label: 'Organic Solidarity',
                color: 'text-green-400',
                description: 'Unity through difference - interdependence binds society'
            };
        }

        // Check for anomie condition
        // Durkheim's anomie = normlessness, when moral regulation fails to keep pace with social change
        // Anomie is CORROSIVE, not instantly fatal - it builds over time
        function checkAnomie() {
            const { solidarity, productivity, legitimacy, innovation } = state.meters;
            const divisionOfLabor = (productivity + innovation) / 2;

            // Anomie occurs when:
            // 1. Rapid social change (high division of labor / differentiation) AND
            // 2. Moral regulation (legitimacy) can't keep up AND/OR
            // 3. Social cohesion has broken down without new integration

            const rapidChange = divisionOfLabor > 50;
            const lowMoralRegulation = legitimacy < 35;
            const cohesionCollapse = solidarity < 30;

            // Anomie when change outpaces regulation
            const changeRegulationGap = divisionOfLabor - legitimacy;

            // Base anomie check
            const anomieConditions = (rapidChange && lowMoralRegulation) ||
                                    (rapidChange && cohesionCollapse) ||
                                    (changeRegulationGap > 35);

            // Occupational groups provide resistance to anomie
            const effectiveAnomie = anomieConditions && state.anomieResistance < 3;

            const wasInAnomie = state.inAnomie;
            state.inAnomie = effectiveAnomie;

            // ANOMIE COUNTDOWN: Sustained anomie leads to collapse
            if (state.inAnomie) {
                state.anomieTurns++;
                anomieWarningEl.classList.remove('hidden');
                // Reveal Moral Regulation meter when anomie first appears
                if (!wasInAnomie) {
                    revealMeter('legitimacy');
                    // First-time anomie tip
                    if (state.firstTimeHints && !state.firstTimeHints.anomie) {
                        state.firstTimeHints.anomie = true;
                        setTimeout(() => showContextualTip(contextualTips.anomie, 'danger', 'bottom', 6000), 1000);
                    }
                }
                // Update warning text to show severity
                const severity = state.anomieTurns >= 3 ? 'CRITICAL' : state.anomieTurns >= 2 ? 'SEVERE' : 'WARNING';
                anomieWarningEl.querySelector('p.text-red-400').textContent = `ANOMIE ${severity}`;
                if (state.anomieTurns >= 2) {
                    anomieWarningEl.querySelector('p.text-red-300').textContent =
                        `Normlessness persists (${state.anomieTurns} turns). Society is fragmenting.`;
                }
            } else {
                // Recovery: anomie counter decreases when conditions improve
                state.anomieTurns = Math.max(0, state.anomieTurns - 1);
                if (state.anomieTurns === 0) {
                    anomieWarningEl.classList.add('hidden');
                } else {
                    anomieWarningEl.querySelector('p.text-red-400').textContent = 'ANOMIE RECOVERING';
                    anomieWarningEl.querySelector('p.text-red-300').textContent =
                        'Conditions improving, but instability lingers...';
                }
            }

            return state.inAnomie;
        }

        // Check for isolation/egoism condition (Modern era risk)
        // Durkheim's egoistic suicide = weak social integration, individuals disconnected from community
        // Distinct from anomie (which is about regulation, not integration)
        function checkIsolation() {
            // Isolation is specifically a MODERN era risk
            // In traditional/transitional societies, low solidarity manifests differently
            if (state.currentEra !== 'modern') {
                state.inIsolation = false;
                isolationWarningEl.classList.add('hidden');
                return false;
            }

            const { solidarity, productivity, legitimacy } = state.meters;

            // Isolation occurs in Modern era when:
            // 1. Solidarity is dangerously low (weak social bonds) AND
            // 2. Productivity is high (people are economically interdependent but socially isolated)
            // This is the "egoistic" condition - functional but disconnected

            const weakBonds = solidarity < 35;
            const highProductivity = productivity > 60;
            const isolationConditions = weakBonds && highProductivity;

            const wasInIsolation = state.inIsolation;
            state.inIsolation = isolationConditions;

            if (state.inIsolation) {
                state.isolationTurns++;
                isolationWarningEl.classList.remove('hidden');

                // First-time isolation tip
                if (!wasInIsolation && state.firstTimeHints && !state.firstTimeHints.isolation) {
                    state.firstTimeHints.isolation = true;
                    setTimeout(() => showContextualTip(contextualTips.isolation, 'danger', 'bottom', 6000), 1000);
                }

                // Update warning text to show severity
                const severity = state.isolationTurns >= 3 ? 'CRITICAL' : state.isolationTurns >= 2 ? 'SEVERE' : 'WARNING';
                isolationWarningEl.querySelector('p.text-purple-400').textContent = `ISOLATION ${severity}`;
                if (state.isolationTurns >= 2) {
                    isolationWarningEl.querySelector('p.text-purple-300').textContent =
                        `Social bonds remain weak (${state.isolationTurns} turns). Egoism threatens cohesion.`;
                }
            } else {
                // Recovery
                state.isolationTurns = Math.max(0, state.isolationTurns - 1);
                if (state.isolationTurns === 0) {
                    isolationWarningEl.classList.add('hidden');
                } else {
                    isolationWarningEl.querySelector('p.text-purple-400').textContent = 'ISOLATION RECOVERING';
                    isolationWarningEl.querySelector('p.text-purple-300').textContent =
                        'Social bonds strengthening, but disconnection lingers...';
                }
            }

            return state.inIsolation;
        }

        // Determine current era - ONE WAY PROGRESSION
        // Once you advance to a new era, you can't go back
        function determineEra() {
            // Time-based era transitions for educational pacing
            // Each era is 25 years: Traditional (0-24), Transitional (25-49), Modern (50-74)
            if (state.year < ERA_TRANSITIONS.transitional) {
                return 'traditional';
            } else if (state.year < ERA_TRANSITIONS.modern) {
                return 'transitional';
            }
            return 'modern';
        }

        // Check if requirements are met to advance to the next era
        // Returns { canAdvance: boolean, failureReason?: string }
        function checkEraTransitionRequirements(targetEra) {
            const reqs = ERA_REQUIREMENTS[targetEra];
            if (!reqs) return { canAdvance: true };

            const { productivity, solidarity } = state.meters;

            if (targetEra === 'transitional') {
                // Traditional → Transitional: Need emerging division of labor
                if (productivity < reqs.productivity) {
                    return {
                        canAdvance: false,
                        failureTitle: reqs.failureTitle,
                        failureMessage: reqs.failureMessage
                    };
                }
            } else if (targetEra === 'modern') {
                // Transitional → Modern: Need specialization + maintained bonds + no anomie
                if (productivity < reqs.productivity) {
                    return {
                        canAdvance: false,
                        failureTitle: reqs.failureTitle,
                        failureMessage: reqs.failureMessages.productivity
                    };
                }
                if (solidarity < reqs.solidarity) {
                    return {
                        canAdvance: false,
                        failureTitle: reqs.failureTitle,
                        failureMessage: reqs.failureMessages.solidarity
                    };
                }
                if (reqs.noAnomie && state.inAnomie) {
                    return {
                        canAdvance: false,
                        failureTitle: reqs.failureTitle,
                        failureMessage: reqs.failureMessages.anomie
                    };
                }
            }

            return { canAdvance: true };
        }

        function updateEra() {
            const newEra = determineEra();
            const previousEra = state.currentEra;

            if (newEra !== previousEra) {
                // Check if requirements are met for this transition
                const reqCheck = checkEraTransitionRequirements(newEra);

                if (!reqCheck.canAdvance) {
                    // Requirements not met - game over with theory-driven message
                    showEraTransitionFailure(reqCheck.failureTitle, reqCheck.failureMessage, previousEra);
                    return;
                }

                // Requirements met - show era transition notification
                let transitionKey = null;
                if (newEra === 'transitional' && previousEra === 'traditional') {
                    transitionKey = 'toTransitional';
                    state.hasReachedTransitional = true;
                    // Reveal Social Differentiation meter when entering transitional era
                    revealMeter('innovation');
                } else if (newEra === 'modern' && previousEra === 'transitional') {
                    transitionKey = 'toModern';
                    state.hasReachedModern = true;
                }

                if (transitionKey) {
                    showEraTransition(transitionKey);
                }

                state.currentEra = newEra;

                // Update solidarity meter label to reflect era-specific meaning
                updateSolidarityMeterLabel();
            }
        }

        // Show game over when era transition requirements aren't met
        function showEraTransitionFailure(title, message, failedEra) {
            state.gameOver = true;
            if (simInterval) clearInterval(simInterval);
            cardContainerEl.classList.remove('player-turn');

            collapseYearEl.textContent = state.year;
            collapseTitleEl.textContent = title;
            collapseSubtitleEl.textContent = `Failed to advance beyond the ${failedEra} era`;
            collapseReasonEl.textContent = message;

            gameOverModalEl.classList.remove('opacity-0', 'invisible');
            gameOverModalEl.querySelector('div').classList.remove('scale-95');
        }

        // Update the solidarity meter's name and tooltip based on current era
        function updateSolidarityMeterLabel() {
            const eraLabels = solidarityMeterByEra[state.currentEra];
            if (!eraLabels) return;

            const meterEl = document.getElementById('meter-solidarity');
            if (!meterEl) return;

            // Update the meter name
            const nameSpan = meterEl.querySelector('.font-semibold');
            if (nameSpan) {
                nameSpan.textContent = eraLabels.name;
            }

            // Update the tooltip
            meterEl.title = eraLabels.tooltip;
        }

        function showEraTransition(transitionKey) {
            const transition = eraTransitions[transitionKey];
            eraTitleEl.textContent = transition.title;
            eraDescriptionEl.textContent = transition.description;
            eraQuoteEl.textContent = transition.quote;

            eraNotificationEl.classList.remove('hidden');

            // Hide after 5 seconds
            setTimeout(() => {
                eraNotificationEl.classList.add('hidden');
            }, 5000);
        }

        // Check win condition
        // Durkheim's vision: A society with organic solidarity where specialization
        // creates interdependence that binds people together, not apart
        function checkWinCondition() {
            if (state.year < WIN_YEAR) return false;

            const { solidarity, productivity, legitimacy, innovation } = state.meters;
            const divisionOfLabor = (productivity + innovation) / 2;

            // Win conditions reflect Durkheim's vision of successful organic solidarity:
            // 1. High division of labor (specialization) - at least 60
            // 2. Maintained social cohesion (not destroyed by change) - at least 35
            // 3. Strong moral regulation (new norms have formed) - at least 40
            // 4. Not in anomie

            const highSpecialization = divisionOfLabor >= 60;
            const maintainedCohesion = solidarity >= 35;
            const stableRegulation = legitimacy >= 40;
            const notInAnomie = !state.inAnomie;

            // All meters must also be stable (not at extremes)
            const noCollapse = solidarity > 10 && productivity > 10 &&
                              legitimacy > 10 && innovation > 10;
            const noOvergrowth = solidarity < 95 && productivity < 95 &&
                                legitimacy < 95 && innovation < 95;

            return highSpecialization && maintainedCohesion && stableRegulation &&
                   notInAnomie && noCollapse && noOvergrowth;
        }

        function showVictory() {
            state.gameOver = true;
            if (simInterval) clearInterval(simInterval);
            cardContainerEl.classList.remove('player-turn');

            victoryYearEl.textContent = state.year;
            victoryModalEl.classList.remove('opacity-0', 'invisible');
            victoryModalEl.querySelector('div').classList.remove('scale-95');
        }

        // Leaderboard functions - Global API with localStorage fallback
        async function fetchGlobalLeaderboard() {
            try {
                const response = await fetch(`${API_URL}/leaderboard?limit=10`);
                if (!response.ok) throw new Error('API error');
                const data = await response.json();
                if (data.success) {
                    return data.scores.map(s => ({
                        name: s.name,
                        score: s.score,
                        won: s.won === 1,
                        finalEra: s.final_era
                    }));
                }
            } catch (error) {
                console.warn('Failed to fetch global leaderboard, using local:', error);
            }
            // Fallback to localStorage
            const stored = localStorage.getItem('equilibrium-leaderboard');
            return stored ? JSON.parse(stored) : [];
        }

        async function submitToGlobalLeaderboard(entry) {
            // Calculate a score based on year reached and win status
            const score = entry.won ? 1000 + entry.year : entry.year;

            try {
                const response = await fetch(`${API_URL}/leaderboard`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: entry.name,
                        score: score,
                        cardsPlayed: Math.floor((entry.year - 2024) / 2),
                        finalEra: state.currentEra,
                        won: entry.won
                    })
                });
                if (!response.ok) throw new Error('API error');
                const data = await response.json();
                if (data.success) {
                    console.log('Score submitted! Rank:', data.rank);
                    return data;
                }
            } catch (error) {
                console.warn('Failed to submit to global leaderboard, saving locally:', error);
            }

            // Fallback: save to localStorage
            const leaderboard = JSON.parse(localStorage.getItem('equilibrium-leaderboard') || '[]');
            leaderboard.push(entry);
            leaderboard.sort((a, b) => {
                if (a.won !== b.won) return b.won - a.won;
                return b.year - a.year;
            });
            const trimmed = leaderboard.slice(0, 10);
            localStorage.setItem('equilibrium-leaderboard', JSON.stringify(trimmed));
            return { success: true, local: true };
        }

        async function renderLeaderboard() {
            leaderboardContentEl.innerHTML = '<p class="text-gray-400">Loading scores...</p>';

            const leaderboard = await fetchGlobalLeaderboard();

            if (leaderboard.length === 0) {
                leaderboardContentEl.innerHTML = '<p class="text-gray-400">No scores yet. Complete a game to save your first score!</p>';
                return;
            }

            let html = '<div class="space-y-2 text-left">';
            leaderboard.forEach((entry, index) => {
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
                const statusColor = entry.won ? 'text-green-400' : 'text-red-400';
                const statusText = entry.won ? 'Victory' : 'Collapsed';
                const yearDisplay = entry.year !== undefined ? `Year ${entry.year}` : `Score: ${entry.score}`;
                html += `
                    <div class="bg-gray-700 rounded-lg p-3 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">${medal}</span>
                            <span class="font-semibold text-white">${escapeHtml(entry.name)}</span>
                        </div>
                        <div class="text-right">
                            <span class="${statusColor} text-sm font-semibold">${statusText}</span>
                            <span class="text-gray-400 text-sm ml-2">${yearDisplay}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            leaderboardContentEl.innerHTML = html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function showLeaderboard() {
            leaderboardModalEl.classList.remove('opacity-0', 'invisible');
            leaderboardModalEl.querySelector('div').classList.remove('scale-95');
            await renderLeaderboard();
        }

        function hideLeaderboard() {
            leaderboardModalEl.classList.add('opacity-0', 'invisible');
            leaderboardModalEl.querySelector('div').classList.add('scale-95');
        }

        function startPlayerGame() {
            // IMMEDIATELY stop simulation to prevent auto-choices during transition
            if (simInterval) {
                clearInterval(simInterval);
                simInterval = null;
            }

            startOverlayEl.classList.add('opacity-0', 'invisible');

            // Tutorial disabled - using contextual first-time hints instead
            const needsTutorial = false;

            // Wait for start overlay to fade out before initializing
            setTimeout(() => {
                resetGame('player', needsTutorial);
            }, 400);
        }

        function updateUI() {
            // Update year progress bar
            const progressPercent = Math.min(100, (state.year / WIN_YEAR) * 100);
            document.getElementById('year-progress-bar').style.width = `${progressPercent}%`;

            for (const key in state.meters) {
                const value = state.meters[key];
                const barEl = document.getElementById(`bar-${key}`);
                const valueEl = document.getElementById(`value-${key}`);
                const iconEl = document.getElementById(`icon-${key}`);
                
                barEl.style.width = `${value}%`;
                valueEl.textContent = `${Math.round(value)}%`;

                if (value <= 15 || value >= 85) {
                    barEl.classList.remove('bg-cyan-500', 'bg-yellow-500');
                    barEl.classList.add('bg-red-500');
                    iconEl.classList.add('danger');
                    // First-time danger tip (only after first choice, not on game start)
                    if (state.year > 0 && state.firstTimeHints && !state.firstTimeHints.meterDanger[key] && state.visibleMeters[key]) {
                        state.firstTimeHints.meterDanger[key] = true;
                        setTimeout(() => showContextualTip(contextualTips.meterDanger[key], 'danger', 'top', 5000), 500);
                    }
                } else if (value <= 30 || value >= 70) {
                    barEl.classList.remove('bg-cyan-500', 'bg-red-500');
                    barEl.classList.add('bg-yellow-500');
                    iconEl.classList.remove('danger');
                    // First-time warning tip (only after first choice, not on game start)
                    if (state.year > 0 && state.firstTimeHints && !state.firstTimeHints.meterWarning[key] && state.visibleMeters[key]) {
                        state.firstTimeHints.meterWarning[key] = true;
                        setTimeout(() => showContextualTip(contextualTips.meterWarning[key], 'warning', 'top', 4000), 500);
                    }
                } else {
                    barEl.classList.remove('bg-yellow-500', 'bg-red-500');
                    barEl.classList.add('bg-cyan-500');
                    iconEl.classList.remove('danger');
                }
            }
        }

        function displayCard() {
            let selectedCard = null;

            // QUESTLINE SYSTEM: Check for triggered cards first
            const dueCards = state.pendingCards.filter(p => p.triggerYear <= state.year);
            if (dueCards.length > 0) {
                // Pick the first due triggered card
                const triggeredCardInfo = dueCards[0];
                const triggeredCard = triggeredCards[triggeredCardInfo.cardId];

                if (triggeredCard) {
                    selectedCard = triggeredCard;
                    // Remove from pending and add to history
                    state.pendingCards = state.pendingCards.filter(p => p.cardId !== triggeredCardInfo.cardId);
                    state.questlineHistory.push(triggeredCardInfo.cardId);
                }
            }

            // If no triggered card, pick from regular cards
            if (!selectedCard) {
                const availableCards = getAvailableCards();

                if (availableCards.length === 0) {
                    console.error('No cards available!');
                    return;
                }

                // Filter out recently used cards (track by character+text to handle era changes)
                const unseenCards = availableCards.filter(card => {
                    const cardKey = card.character + '|' + card.text;
                    return !state.usedCardKeys.includes(cardKey);
                });

                // Reset if we've seen all available cards
                const cardsToChooseFrom = unseenCards.length > 0 ? unseenCards : availableCards;
                if (unseenCards.length === 0) {
                    state.usedCardKeys = [];
                }

                // Pick a random card
                const randomIndex = Math.floor(Math.random() * cardsToChooseFrom.length);
                selectedCard = cardsToChooseFrom[randomIndex];

                // Track this card as used
                const cardKey = selectedCard.character + '|' + selectedCard.text;
                state.usedCardKeys.push(cardKey);
            }

            state.currentCard = selectedCard;

            // Randomly swap choice positions to prevent pattern-matching
            // (students can't just always click left for "tradition")
            state.choicesSwapped = Math.random() > 0.5;

            cardCharacterEl.textContent = selectedCard.character;
            cardTextEl.textContent = selectedCard.text;

            if (state.choicesSwapped) {
                choiceATextEl.textContent = selectedCard.choiceB.text;
                choiceBTextEl.textContent = selectedCard.choiceA.text;
            } else {
                choiceATextEl.textContent = selectedCard.choiceA.text;
                choiceBTextEl.textContent = selectedCard.choiceB.text;
            }

            cardEl.style.transform = 'translateX(0) rotate(0deg)';
            cardEl.style.opacity = 1;
            cardEl.classList.remove('card-swipe-left', 'card-swipe-right');

            // First-choice welcome tip
            if (state.firstTimeHints && !state.firstTimeHints.firstChoice && state.year === 0) {
                state.firstTimeHints.firstChoice = true;
                setTimeout(() => showContextualTip(contextualTips.firstChoice, 'info', 'bottom', 5000), 800);
            }
        }

        // Durkheimian insights based on choice effects
        const durkheimInsights = {
            // Solidarity effects
            solidarity_up: [
                "Strengthening collective bonds - Durkheim saw this as essential for any society.",
                "Social cohesion increased. In Durkheim's terms, you're reinforcing the 'collective conscience.'",
                "Bonds between members grow stronger. Whether mechanical or organic, solidarity is the glue of society."
            ],
            solidarity_down: [
                "Weakening social bonds. Durkheim warned that without solidarity, anomie follows.",
                "Cohesion decreases. The ties that bind people together are loosening.",
                "Social integration weakens. Isolated individuals struggle to find meaning."
            ],
            // Productivity (Division of Labor) effects
            productivity_up: [
                "Division of labor increases. Durkheim saw this as the engine of modern solidarity.",
                "Specialization grows. People become more interdependent through their different roles.",
                "Economic complexity rises. This can create organic solidarity - or anomie, if unregulated."
            ],
            productivity_down: [
                "Division of labor decreases. Society remains less specialized.",
                "Economic activity slows. Less specialization means less interdependence.",
                "Complexity reduces. Simpler economies may be more stable but less dynamic."
            ],
            // Legitimacy (Moral Regulation) effects
            legitimacy_up: [
                "Moral authority strengthens. Durkheim emphasized that norms must keep pace with change.",
                "Institutions gain trust. Legitimate rules help prevent anomie.",
                "Regulatory capacity grows. Strong moral regulation helps prevent anomie."
            ],
            legitimacy_down: [
                "Moral authority weakens. When rules lose legitimacy, anomie threatens.",
                "Institutional trust erodes. Without respected norms, desires become unlimited.",
                "Regulation falters. Durkheim warned: the market alone cannot ensure order."
            ],
            // Innovation (Social Differentiation) effects
            innovation_up: [
                "Social differentiation increases. Individual roles become more distinct.",
                "Diversity grows. Organic solidarity requires each person to have their own sphere.",
                "Note: Innovation gains are reduced if integration (solidarity + legitimacy) is low."
            ],
            innovation_down: [
                "Differentiation decreases. Society becomes more homogeneous.",
                "Individuality constrained. Durkheim saw some differentiation as necessary for modern life.",
                "Diversity shrinks. Too little difference undermines organic solidarity."
            ],
            // Mixed/balanced
            balanced: [
                "A balanced choice. Durkheim noted that healthy societies manage trade-offs carefully.",
                "Mixed effects. The transition from mechanical to organic solidarity is never simple.",
                "Trade-offs everywhere. Every choice shapes what kind of solidarity is possible."
            ],
            anomie_risk: [
                "Warning: This pushes toward anomie - change is outpacing moral regulation.",
                "Caution: Growing gap between economic change and normative framework.",
                "Durkheim's warning: unregulated expansion leads to normlessness."
            ]
        };

        function getRandomInsight(key) {
            const insights = durkheimInsights[key];
            return insights[Math.floor(Math.random() * insights.length)];
        }

        // --- TUTORIAL FUNCTIONS ---
        function showTutorialOverlay() {
            if (!state.inTutorial || state.tutorialStep >= tutorialCards.length) return;

            const tutorialCard = tutorialCards[state.tutorialStep];
            const lesson = tutorialCard.lesson;

            tutorialTitleEl.textContent = `${state.tutorialStep + 1}/5: ${lesson.title}`;
            tutorialContentEl.innerHTML = lesson.content;

            // Update progress dots
            const dots = tutorialProgressEl.querySelectorAll('.tutorial-progress-dot');
            dots.forEach((dot, i) => {
                dot.classList.remove('active', 'completed');
                if (i < state.tutorialStep) {
                    dot.classList.add('completed');
                } else if (i === state.tutorialStep) {
                    dot.classList.add('active');
                }
            });

            // Apply highlight based on lesson type
            removeAllHighlights();
            if (lesson.highlight === 'meters') {
                metersContainerEl.classList.add('tutorial-highlight');
            } else if (lesson.highlight === 'choices') {
                choiceADiv.classList.add('tutorial-highlight');
                choiceBDiv.classList.add('tutorial-highlight');
            }

            // Show overlay
            tutorialOverlayEl.classList.remove('opacity-0', 'invisible');
            tutorialOverlayEl.querySelector('div').classList.remove('scale-95');
        }

        function hideTutorialOverlay() {
            tutorialOverlayEl.classList.add('opacity-0', 'invisible');
            tutorialOverlayEl.querySelector('div').classList.add('scale-95');
            removeAllHighlights();
        }

        function removeAllHighlights() {
            metersContainerEl.classList.remove('tutorial-highlight');
            choiceADiv.classList.remove('tutorial-highlight');
            choiceBDiv.classList.remove('tutorial-highlight');
        }

        function displayTutorialCard() {
            if (!state.inTutorial || state.tutorialStep >= tutorialCards.length) return;

            const tutorialCard = tutorialCards[state.tutorialStep];
            state.currentCard = {
                character: tutorialCard.character,
                text: tutorialCard.text,
                choiceA: tutorialCard.choiceA,
                choiceB: tutorialCard.choiceB
            };

            // Tutorial keeps choices in consistent positions for teaching
            state.choicesSwapped = false;

            cardCharacterEl.textContent = state.currentCard.character;
            cardTextEl.textContent = state.currentCard.text;
            choiceATextEl.textContent = state.currentCard.choiceA.text;
            choiceBTextEl.textContent = state.currentCard.choiceB.text;

            cardEl.style.transform = 'translateX(0) rotate(0deg)';
            cardEl.style.opacity = 1;
            cardEl.classList.remove('card-swipe-left', 'card-swipe-right');

            // Show tutorial overlay after card appears
            setTimeout(showTutorialOverlay, 200);
        }

        function advanceTutorial() {
            state.tutorialStep++;

            if (state.tutorialStep >= tutorialCards.length) {
                // Tutorial complete
                state.inTutorial = false;
                localStorage.setItem('equilibrium_tutorial_completed', 'true');
                hideTutorialOverlay();
                // Continue to regular game
                setTimeout(displayCard, 500);
            } else {
                // Show next tutorial card
                hideTutorialOverlay();
                setTimeout(displayTutorialCard, 300);
            }
        }

        function skipTutorial() {
            state.inTutorial = false;
            localStorage.setItem('equilibrium_tutorial_completed', 'true');
            hideTutorialOverlay();
            // Reset to Year 0 and start fresh
            state.year = STARTING_YEAR;
            state.tutorialStep = 0;
            updateUI();
            setTimeout(displayCard, 300);
        }

        function showChoiceFeedback(choiceText, effects, metersBefore, tutorialFeedback = null) {
            feedbackChoiceEl.textContent = `"${choiceText}"`;

            // Build effects display - compact badges (only for visible meters)
            let effectsHtml = '';

            for (const key in effects) {
                const value = effects[key];
                if (value === 0) continue;

                // Only show effects for visible meters
                if (!state.visibleMeters[key]) continue;

                const sign = value > 0 ? '+' : '';
                const bgColor = value > 0 ? 'bg-green-900 border-green-700' : 'bg-red-900 border-red-700';
                const textColor = value > 0 ? 'text-green-400' : 'text-red-400';

                effectsHtml += `
                    <div class="${bgColor} border rounded-lg px-3 py-1 flex items-center gap-1">
                        <span>${getIcon(key, 'w-4 h-4')}</span>
                        <span class="${textColor} font-bold">${sign}${value}</span>
                    </div>
                `;
            }

            feedbackEffectsEl.innerHTML = effectsHtml || '<span class="text-gray-500">No major effects</span>';

            // Handle tutorial mode vs normal mode
            if (tutorialFeedback) {
                // Tutorial mode: show explanation and require click to continue
                feedbackInsightEl.classList.add('hidden');
                feedbackTutorialSection.classList.remove('hidden');
                document.getElementById('feedback-tap-hint').classList.add('hidden');
                feedbackTutorialText.innerHTML = tutorialFeedback;
                feedbackSplashEl.classList.remove('pointer-events-none');
                feedbackSplashEl.classList.add('bg-black', 'bg-opacity-50');
            } else {
                // Normal mode: show insight and make tap-to-dismiss
                feedbackInsightEl.classList.remove('hidden');
                feedbackTutorialSection.classList.add('hidden');
                document.getElementById('feedback-tap-hint').classList.remove('hidden');
                feedbackSplashEl.classList.remove('pointer-events-none');
                feedbackSplashEl.classList.add('bg-black', 'bg-opacity-30');

                // Generate Durkheimian insight
                let insightKey = 'balanced';
                const solidarityEffect = effects.solidarity || 0;
                const productivityEffect = effects.productivity || 0;
                const legitimacyEffect = effects.legitimacy || 0;
                const innovationEffect = effects.innovation || 0;

                if ((productivityEffect > 10 || innovationEffect > 10) && legitimacyEffect < 0) {
                    insightKey = 'anomie_risk';
                } else if (Math.abs(solidarityEffect) >= Math.abs(productivityEffect) &&
                           Math.abs(solidarityEffect) >= Math.abs(legitimacyEffect) &&
                           Math.abs(solidarityEffect) >= Math.abs(innovationEffect)) {
                    insightKey = solidarityEffect > 0 ? 'solidarity_up' : 'solidarity_down';
                } else if (Math.abs(productivityEffect) >= Math.abs(legitimacyEffect) &&
                           Math.abs(productivityEffect) >= Math.abs(innovationEffect)) {
                    insightKey = productivityEffect > 0 ? 'productivity_up' : 'productivity_down';
                } else if (Math.abs(legitimacyEffect) >= Math.abs(innovationEffect)) {
                    insightKey = legitimacyEffect > 0 ? 'legitimacy_up' : 'legitimacy_down';
                } else if (innovationEffect !== 0) {
                    insightKey = innovationEffect > 0 ? 'innovation_up' : 'innovation_down';
                }

                feedbackInsightEl.textContent = getRandomInsight(insightKey);
            }

            // Show the splash
            feedbackSplashEl.classList.remove('opacity-0');
            feedbackSplashEl.querySelector('div').classList.remove('scale-95');

            // Auto-hide after 6 seconds as fallback (only in normal mode)
            // User can also tap to dismiss earlier
            if (!tutorialFeedback) {
                state.feedbackTimeout = setTimeout(() => {
                    if (!state.gameOver) {
                        hideFeedbackSplash();
                    }
                }, 6000);
            }
        }

        function hideFeedbackSplash() {
            feedbackSplashEl.classList.add('opacity-0');
            feedbackSplashEl.querySelector('div').classList.add('scale-95');
            feedbackSplashEl.classList.add('pointer-events-none');
            feedbackSplashEl.classList.remove('bg-black', 'bg-opacity-50', 'bg-opacity-30');
            document.getElementById('feedback-tap-hint').classList.add('hidden');
        }

        function handleChoice(choiceKey) {
            const originalEffects = { ...state.currentCard[choiceKey].effects };
            const choiceText = state.currentCard[choiceKey].text;
            const metersBefore = { ...state.meters };

            // Apply effects directly - what you see is what you get
            for (const key in originalEffects) {
                state.meters[key] += originalEffects[key];
            }

            // 6. OCCUPATIONAL DENSITY: Professional groups stabilize modern society
            updateAnonieResistance();

            // Clamp meters to 0-100 range
            for (const key in state.meters) {
                state.meters[key] = Math.max(0, Math.min(100, state.meters[key]));
            }

            state.year += 1;
            updateUI();
            updateEra();
            checkAnomie();
            checkIsolation();

            // Show feedback on the choice (player mode only)
            if (state.gameMode === 'player') {
                if (state.inTutorial) {
                    // Tutorial mode: get feedback text from tutorial card
                    const tutorialCard = tutorialCards[state.tutorialStep];
                    const feedbackText = tutorialCard[choiceKey]?.feedback || '';
                    showChoiceFeedback(choiceText, originalEffects, metersBefore, feedbackText);
                } else {
                    // Normal mode: auto-hiding feedback
                    showChoiceFeedback(choiceText, originalEffects, metersBefore);
                }
            }

            // 7. QUESTLINE TRIGGERS: Check if this choice triggers future cards
            const choiceData = state.currentCard[choiceKey];
            if (choiceData.triggers && Array.isArray(choiceData.triggers)) {
                choiceData.triggers.forEach(trigger => {
                    // Only add if not already pending and not already triggered
                    const alreadyPending = state.pendingCards.some(p => p.cardId === trigger.cardId);
                    const alreadyTriggered = state.questlineHistory.includes(trigger.cardId);
                    if (!alreadyPending && !alreadyTriggered) {
                        state.pendingCards.push({
                            cardId: trigger.cardId,
                            triggerYear: state.year + trigger.delay
                        });
                    }
                });
            }

            // Check win condition first
            if (checkWinCondition()) {
                showVictory();
                return;
            }

            checkGameOver();
        }

        // Occupational groups provide anomie resistance
        function updateAnonieResistance() {
            const { solidarity, productivity, innovation } = state.meters;
            const divisionOfLabor = (productivity + innovation) / 2;

            // When specialization rises WITH maintained solidarity,
            // occupational groups form and resist anomie
            if (divisionOfLabor > 55 && solidarity > 40) {
                state.anomieResistance = Math.min(5, state.anomieResistance + 1);
            } else if (state.anomieResistance > 0) {
                state.anomieResistance -= 0.5;
            }
        }

        // Era-specific collapse conditions based on Durkheim
        const eraCollapseConditions = {
            traditional: {
                // Mechanical solidarity collapses
                collectiveConscienceCollapse: {
                    check: (m) => m.solidarity <= 0,
                    reason: "The Collective Conscience Has Dissolved",
                    explanation: "Your society did not fail through malice—the shared beliefs that once bound everyone together simply ceased to be believed. Without a collective conscience, there was nothing to be mechanical solidarity *of*.",
                    quote: "\"The totality of beliefs and sentiments common to average citizens of the same society forms a determinate system which has its own life; one may call it the collective conscience.\" - Durkheim"
                },
                repressiveExcess: {
                    check: (m) => m.legitimacy >= 100 && m.innovation < 25,
                    reason: "Moral Regulation Became Oppressive",
                    explanation: "Your Moral Regulation meter hit 100% while Social Differentiation stayed below 25%. Rigid enforcement of traditional norms crushed all individual expression. The community suffocated under its own rules.",
                    quote: "\"Repressive law corresponds to the heart of the collective conscience... but when punishment becomes the purpose rather than the means, society suffocates.\" - Durkheim"
                },
                stiflingConformity: {
                    check: (m) => m.solidarity >= 100 && m.innovation < 25,
                    reason: "Collective Conscience Crushed All Individuality",
                    explanation: "Your Social Cohesion meter hit 100% while Social Differentiation stayed below 25%. The bonds of similarity became so tight that no individual difference could survive. Society froze in place.",
                    quote: "\"The individual personality is absorbed into the collective personality... the individual has no sphere of action peculiar to himself.\" - Durkheim"
                },
                sacredOrderViolated: {
                    check: (m) => m.legitimacy <= 0,
                    reason: "The Sacred Has Lost Its Power",
                    explanation: "Traditional authority drew its force from shared sacred beliefs. When nothing remained sacred, there was no foundation for social order—not because people became wicked, but because they became strangers to each other.",
                    quote: "\"Religion contains in itself from the very beginning all the elements which have given rise to the various manifestations of collective life.\" - Durkheim"
                },
                stagnation: {
                    check: (m) => m.innovation <= 0,
                    reason: "Society Became Its Own Museum",
                    explanation: "By refusing all change, your society lost the capacity to respond to new conditions. Tradition became a prison rather than a home.",
                    quote: "\"When the conscience collective becomes too rigid, it loses the plasticity required to adapt to changing circumstances.\" - Durkheim"
                },
                prematureModernization: {
                    check: (m) => m.productivity >= 100 && m.solidarity < 30,
                    reason: "Change Outran Understanding",
                    explanation: "The division of labor expanded before people could develop new forms of connection. They became interdependent strangers—needing each other but not knowing how to be together.",
                    quote: "\"If the division of labor does not produce solidarity, it is because the relations between the organs are not regulated.\" - Durkheim"
                }
            },
            transitional: {
                // The danger zone - anomie is the key risk
                anomicCrisis: {
                    check: (m, s) => s.anomieTurns >= 4,
                    reason: "Sustained Anomie - Normlessness Has Taken Hold",
                    explanation: "Your society did not lack intelligence or goodwill—but its institutions no longer fit its structure. Old rules broke down faster than new ones could form.",
                    quote: "\"Anomie is impossible wherever interdependent organs are sufficiently in contact and sufficiently extensive. If they are close enough, they are quickly aware of the need they have for one another.\" - Durkheim"
                },
                socialDisintegration: {
                    check: (m) => m.solidarity <= 0,
                    reason: "The Bonds Broke Before New Ones Formed",
                    explanation: "Every society in transition walks a tightrope. Old forms of connection weaken as new ones emerge. Your society fell into the gap between—not from wickedness, but from a misalignment of pace.",
                    quote: "\"Individuals are so busy with the functional task at hand that they lose sight of their collaborators, no longer sense their common solidarity.\" - Durkheim"
                },
                regulatoryCollapse: {
                    check: (m) => m.legitimacy <= 0,
                    reason: "Between Two Moral Orders",
                    explanation: "The old rules lost their hold before new ones could form. This is not a failure of morality—it's a structural gap. Professional ethics and modern institutions take time to develop authority.",
                    quote: "\"There is no society which can maintain itself without a minimum of moral regulation; the market alone cannot ensure order.\" - Durkheim"
                },
                forcedDivision: {
                    check: (m) => m.productivity >= 100 && m.solidarity < 30,
                    reason: "Forced Division of Labor",
                    explanation: "The division of labor was imposed rather than grown. People were pushed into roles by circumstance or power rather than finding their natural place. Such a society is always unstable.",
                    quote: "\"The forced division of labor is... a further source of anomie. Labor is divided spontaneously only if society is constituted in such a way that social inequalities exactly express natural inequalities.\" - Durkheim"
                },
                chaosOfChange: {
                    check: (m) => m.innovation >= 100 && m.legitimacy < 30,
                    reason: "Differentiation Without Direction",
                    explanation: "Difference multiplied faster than society could make sense of it. Innovation is necessary—but only integration makes it meaningful. Your society had diversity without coherence.",
                    quote: "\"It is not enough for there to be rules; they must also be just. The regulation must keep pace with the transformation.\" - Durkheim"
                }
            },
            modern: {
                // Organic solidarity failures
                anomicDivisionOfLabor: {
                    check: (m, s) => s.anomieTurns >= 4,
                    reason: "Anomic Division of Labor",
                    explanation: "Your society achieved remarkable specialization—but the moral framework didn't keep pace. Economic life became amoral, and interdependence bred resentment rather than solidarity.",
                    quote: "\"In the economic order, the anomic division of labor has become chronic... industrial and commercial functions are almost entirely lacking in moral regulation.\" - Durkheim"
                },
                egoism: {
                    check: (m, s) => s.isolationTurns >= 4,
                    reason: "Egoistic Isolation - Society of Strangers",
                    explanation: "Your society achieved economic interdependence, but individuals became disconnected from meaningful community. People work together but live alone.",
                    quote: "\"The bond which unites men to society is weaker, they are more easily detached... The more weakened the groups to which he belongs, the less he depends on them.\" - Durkheim"
                },
                organicSolidarityFailure: {
                    check: (m) => m.solidarity <= 0,
                    reason: "Interdependence Without Integration",
                    explanation: "People depended on each other economically, but never came to feel it as a bond. Functional necessity is not the same as social cohesion.",
                    quote: "\"Each individual is the more closely dependent upon society the more divided labor is... but this dependence must become a felt bond.\" - Durkheim"
                },
                professionalEthicsCollapse: {
                    check: (m) => m.legitimacy <= 0,
                    reason: "The Moral Vacuum of Economic Life",
                    explanation: "The occupational groups that should regulate modern life never developed adequate ethics. The market cannot moralize itself.",
                    quote: "\"A group is not only a moral authority which dominates the life of its members; it is also a source of life sui generis.\" - Durkheim"
                },
                hyperSpecialization: {
                    check: (m) => m.productivity >= 100 && m.solidarity < 30,
                    reason: "The Worker Becomes a Cog",
                    explanation: "Specialization exceeded the point of meaningful integration. People became so narrowly defined by their function that they lost connection to the whole.",
                    quote: "\"As work becomes more divided, the worker becomes weaker... he is no longer anything but an inert piece of machinery.\" - Durkheim"
                },
                homogenizationCollapse: {
                    check: (m) => m.innovation <= 0,
                    reason: "Individuality Crushed",
                    explanation: "Organic solidarity requires that each person have their own sphere. By eliminating difference, society destroyed the very basis of modern integration.",
                    quote: "\"Organic solidarity is possible only if each one has a sphere of action which is peculiar to him; that is, a personality.\" - Durkheim"
                }
            }
        };

        function checkGameOver() {
            let collapseData = null;

            // Get current era's collapse conditions
            const conditions = eraCollapseConditions[state.currentEra];

            // Check each condition for current era
            for (const key in conditions) {
                const condition = conditions[key];
                if (condition.check(state.meters, state)) {
                    collapseData = condition;
                    break;
                }
            }

            if (collapseData) {
                state.gameOver = true;
                if (simInterval) clearInterval(simInterval);

                // Era-specific collapse titles
                const eraTitles = {
                    traditional: "Mechanical Solidarity Collapsed!",
                    transitional: "The Transition Failed!",
                    modern: "Organic Solidarity Collapsed!"
                };

                document.getElementById('collapse-title').textContent = eraTitles[state.currentEra];
                finalYearEl.textContent = state.year;
                collapseReasonEl.textContent = collapseData.reason;

                // Set reflection content
                reflectionQuestionEl.textContent = collapseData.explanation;
                durkheimQuoteEl.textContent = collapseData.quote;

                gameOverModalEl.classList.remove('opacity-0', 'invisible');
                gameOverModalEl.querySelector('div').classList.remove('scale-95');
                cardContainerEl.classList.remove('player-turn');
            }
        }

        function runSimTurn() {
            if (state.gameOver) return;
            const choice = Math.random() > 0.5 ? 'choiceA' : 'choiceB';
            cardEl.classList.add(choice === 'choiceA' ? 'card-swipe-left' : 'card-swipe-right');
            
            setTimeout(() => {
                handleChoice(choice);
                if (!state.gameOver) {
                    displayCard();
                }
            }, 1000);
        }

        function handlePlayerChoice(visualChoice) {
            if (state.gameOver || state.gameMode !== 'player') return;

            // Translate visual position to actual choice (accounting for random swap)
            let actualChoice = visualChoice;
            if (state.choicesSwapped) {
                actualChoice = visualChoice === 'choiceA' ? 'choiceB' : 'choiceA';
            }

            cardContainerEl.classList.remove('player-turn'); // Disable hover effects during animation
            cardEl.classList.add(visualChoice === 'choiceA' ? 'card-swipe-left' : 'card-swipe-right');

            setTimeout(() => {
                handleChoice(actualChoice);
                if (!state.gameOver) {
                    if (state.inTutorial) {
                        // In tutorial mode: feedback splash will handle advancing
                        // (user clicks "Next" button)
                    } else {
                        displayCard();
                        cardContainerEl.classList.add('player-turn'); // Re-enable hover effects
                    }
                }
            }, 1000);
        }

        // --- INITIALIZATION ---
        startPlayerGameBtn.addEventListener('click', startPlayerGame);
        playAgainBtn.addEventListener('click', () => {
            gameOverModalEl.classList.add('opacity-0', 'invisible');
            resetGame('player');
        });
        choiceADiv.addEventListener('click', () => handlePlayerChoice('choiceA'));
        choiceBDiv.addEventListener('click', () => handlePlayerChoice('choiceB'));

        // Leaderboard buttons
        viewLeaderboardBtn.addEventListener('click', showLeaderboard);
        collapseLeaderboardBtn.addEventListener('click', showLeaderboard);

        closeLeaderboardBtn.addEventListener('click', () => {
            hideLeaderboard();
            // Show start overlay if game is over
            if (state.gameOver) {
                startOverlayEl.classList.remove('opacity-0', 'invisible');
            }
        });


        // Tutorial buttons
        tutorialContinueBtn.addEventListener('click', () => {
            hideTutorialOverlay();
            // Player will make their choice, then feedback splash appears
        });

        tutorialSkipBtn.addEventListener('click', skipTutorial);

        // Feedback splash "Next" button (tutorial mode)
        feedbackNextBtn.addEventListener('click', () => {
            hideFeedbackSplash();
            advanceTutorial();
            cardContainerEl.classList.add('player-turn'); // Re-enable hover effects
        });

        // Feedback splash tap-to-dismiss (normal mode)
        feedbackSplashEl.addEventListener('click', (e) => {
            // Only dismiss in normal mode (not tutorial)
            if (!state.inTutorial && !feedbackSplashEl.classList.contains('pointer-events-none')) {
                // Clear the auto-hide timeout
                if (state.feedbackTimeout) {
                    clearTimeout(state.feedbackTimeout);
                }
                hideFeedbackSplash();
            }
        });

        // === MOBILE SWIPE SUPPORT ===
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let isSwiping = false;

        cardEl.addEventListener('touchstart', (e) => {
            if (state.gameMode !== 'player' || state.gameOver) return;
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
            isSwiping = true;
        }, { passive: true });

        cardEl.addEventListener('touchmove', (e) => {
            if (!isSwiping || state.gameMode !== 'player') return;
            const currentX = e.changedTouches[0].screenX;
            const diffX = currentX - touchStartX;

            // Visual feedback during swipe
            const rotation = diffX * 0.1;
            const opacity = Math.max(0.5, 1 - Math.abs(diffX) / 500);
            cardEl.style.transform = `translateX(${diffX}px) rotate(${rotation}deg)`;
            cardEl.style.opacity = opacity;

            // Highlight the choice being swiped toward
            if (diffX < -30) {
                choiceADiv.classList.add('border-cyan-400', 'bg-gray-600');
                choiceBDiv.classList.remove('border-cyan-400', 'bg-gray-600');
            } else if (diffX > 30) {
                choiceBDiv.classList.add('border-cyan-400', 'bg-gray-600');
                choiceADiv.classList.remove('border-cyan-400', 'bg-gray-600');
            } else {
                choiceADiv.classList.remove('border-cyan-400', 'bg-gray-600');
                choiceBDiv.classList.remove('border-cyan-400', 'bg-gray-600');
            }
        }, { passive: true });

        cardEl.addEventListener('touchend', (e) => {
            if (!isSwiping || state.gameMode !== 'player' || state.gameOver) return;
            isSwiping = false;

            touchEndX = e.changedTouches[0].screenX;
            const diffX = touchEndX - touchStartX;
            const diffY = Math.abs(e.changedTouches[0].screenY - touchStartY);

            // Reset visual highlights
            choiceADiv.classList.remove('border-cyan-400', 'bg-gray-600');
            choiceBDiv.classList.remove('border-cyan-400', 'bg-gray-600');

            // Only register swipe if horizontal movement > vertical and > threshold
            const swipeThreshold = 80;
            if (Math.abs(diffX) > swipeThreshold && Math.abs(diffX) > diffY) {
                const choiceKey = diffX < 0 ? 'choiceA' : 'choiceB';
                cardEl.classList.add(diffX < 0 ? 'card-swipe-left' : 'card-swipe-right');
                setTimeout(() => {
                    handleChoice(choiceKey);
                    if (!state.gameOver) {
                        if (state.inTutorial) {
                            // Tutorial mode: feedback splash handles advancing
                        } else {
                            setTimeout(displayCard, 300);
                        }
                    }
                }, 200);
            } else {
                // Reset card position if swipe wasn't far enough
                cardEl.style.transform = 'translateX(0) rotate(0deg)';
                cardEl.style.opacity = 1;
            }
        }, { passive: true });

        // Victory submission
        submitScoreBtn.addEventListener('click', async () => {
            const name = winnerNameEl.value.trim() || 'Anonymous';
            submitScoreBtn.disabled = true;
            submitScoreBtn.textContent = 'Submitting...';

            await submitToGlobalLeaderboard({
                name: name,
                year: state.year,
                won: true,
                date: new Date().toISOString()
            });

            victoryModalEl.classList.add('opacity-0', 'invisible');
            submitScoreBtn.disabled = false;
            submitScoreBtn.textContent = 'Save Score';
            showLeaderboard();
        });

        // Initialize game
        async function initGame() {
            await loadCards();
            initializeMeters();
            resetGame('sim');
        }

        initGame();

    </script>
</body>
</html>